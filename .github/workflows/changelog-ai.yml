name: AI Changelog Suggestion

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  suggest-changelog:
    runs-on: ubuntu-latest
    # Skip release PRs and bot PRs
    if: "!startsWith(github.head_ref, 'release/') && github.actor != 'dependabot[bot]'"
    permissions:
      contents: read
      pull-requests: write
      models: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD -- ':(exclude)*.lock' ':(exclude)CHANGELOG.md' | head -c 10000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate changelog with AI
        id: ai
        uses: actions/github-script@v7
        env:
          DIFF: ${{ steps.diff.outputs.diff }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        with:
          script: |
            const diff = process.env.DIFF;
            const prTitle = process.env.PR_TITLE;
            const prBody = process.env.PR_BODY || '';
            
            const prompt = `You are analyzing a pull request for PMaaS (Pub Meeting as a Service), a fun FastAPI app that returns pub-themed meeting names.

            PR Title: ${prTitle}
            PR Description: ${prBody}
            
            Code diff:
            \`\`\`
            ${diff}
            \`\`\`
            
            Generate a changelog entry in Keep a Changelog format. Use the appropriate section(s):
            - **Added** for new features
            - **Changed** for changes in existing functionality  
            - **Deprecated** for soon-to-be removed features
            - **Removed** for now removed features
            - **Fixed** for bug fixes
            - **Security** for vulnerability fixes
            
            Keep the tone light and fun (matching the project's pub theme). Be concise - one line per change.
            Output ONLY the markdown for the changelog entry, nothing else. Example format:
            
            ### Added
            - New pub-themed meeting name "Hops Analysis" üç∫`;

            try {
              const response = await fetch('https://models.github.ai/inference/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${process.env.GITHUB_TOKEN}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  model: 'openai/gpt-4o-mini',
                  messages: [{ role: 'user', content: prompt }],
                  max_tokens: 500
                })
              });

              if (!response.ok) {
                const error = await response.text();
                console.log('AI API error:', error);
                core.setOutput('changelog', '');
                return;
              }

              const data = await response.json();
              const changelog = data.choices[0]?.message?.content || '';
              core.setOutput('changelog', changelog);
            } catch (error) {
              console.log('Error calling AI:', error);
              core.setOutput('changelog', '');
            }

      - name: Comment on PR
        if: steps.ai.outputs.changelog != ''
        uses: actions/github-script@v7
        with:
          script: |
            const changelog = `${{ steps.ai.outputs.changelog }}`;
            const marker = '<!-- changelog-ai-suggestion -->';
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const existingComment = comments.find(c => c.body.includes(marker));
            
            const body = `${marker}
            ## üìù Suggested Changelog Entry
            
            Based on this PR's changes, here's a suggested changelog entry:
            
            ${changelog}
            
            ---
            <sub>ü§ñ Generated by AI ‚Ä¢ Add to \`CHANGELOG.md\` under \`[Unreleased]\` if appropriate</sub>`;
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
